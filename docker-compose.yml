services:
  # --- MongoDB ---
  mongodb:
    image: mirror.gcr.io/library/mongo:7.0
    container_name: mongodb
    ports: 
      - "27017:27017"  # publish for host access
    networks: [appnet]

  # --- Tags Service ---
  tags:
    build:
      context: ./tags-service
      dockerfile: Dockerfile
    container_name: tags
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DATABASE=tags_db
    ports: ["8001:8000"]
    depends_on:
      mongodb: { condition: service_started }
    networks: [appnet]

  # --- Moderate Service ---
  moderate:
    build:
      context: ./moderate-service
      dockerfile: Dockerfile
    container_name: moderate
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DATABASE=tags_db
      - JWT_SECRET=change-me-in-prod
    ports: ["8002:8002"]
    depends_on:
      mongodb: { condition: service_started }
    networks: [appnet]

  # --- NGINX ---
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx-lb
    ports: ["8080:80"]
    depends_on:
      - tags
      - moderate
      - videos
    networks: [appnet]

  # --- Videos Service ---
  videos:
    build:
      context: ./videos-service
      dockerfile: Dockerfile
    container_name: videos
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DATABASE=tags_db
    ports: ["8003:8000"]
    depends_on:
      mongodb: { condition: service_started }
    networks: [appnet]

networks:
  appnet:
    driver: bridge
