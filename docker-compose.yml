services:
  # --- Tags Service ---
  tags:
    build:
      context: ./tags-service
      dockerfile: Dockerfile
    container_name: tags
    environment:
      # Set these in your .env file or use environment variables
      # For MongoDB Atlas, use format: mongodb+srv://username:password@cluster.mongodb.net/database?retryWrites=true&w=majority
      - MONGODB_URL=${MONGODB_URL:-mongodb://localhost:27017}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-tags_db}
    ports: ["8001:8000"]
    networks: [appnet]

  # --- Moderate Service ---
  moderate:
    build:
      context: ./moderate-service
      dockerfile: Dockerfile
    container_name: moderate
    environment:
      - MONGODB_URL=${MONGODB_URL:-mongodb://localhost:27017}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-tags_db}
      - JWT_SECRET=${JWT_SECRET:-change-me-in-prod}
    ports: ["8002:8002"]
    networks: [appnet]

  # --- Videos Service ---
  videos:
    build:
      context: ./videos-service
      dockerfile: Dockerfile
    container_name: videos
    environment:
      - MONGODB_URL=${MONGODB_URL:-mongodb://localhost:27017}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-tags_db}
    ports: ["8003:8000"]
    networks: [appnet]

  # --- NGINX (optional, for local development) ---
  # Note: For Render deployment, you'll deploy services individually
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx-lb
    ports: ["8080:80"]
    depends_on:
      - tags
      - moderate
      - videos
    networks: [appnet]

networks:
  appnet:
    driver: bridge
